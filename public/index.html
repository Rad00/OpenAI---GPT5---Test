<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Solar Configurator MVP</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    #controls { padding: 1rem; }
    #scene-container { width: 100%; height: 400px; }
    input { margin-right: 0.5rem; }
  </style>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';
    window.THREE = THREE;
    window.OrbitControls = OrbitControls;
  </script>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
function App() {
  const [width, setWidth] = React.useState(6);
  const [length, setLength] = React.useState(10);
  const [pitch, setPitch] = React.useState(30);
  const [numPanels, setNumPanels] = React.useState(0);
  const [kwp, setKwp] = React.useState(0);
  const [packages, setPackages] = React.useState([]);
  const sceneRef = React.useRef();
  const roofRef = React.useRef();

  React.useEffect(() => {
    const container = document.getElementById('scene-container');
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
    camera.position.set(0, 5, 10);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    container.appendChild(renderer.domElement);
    const controls = new OrbitControls(camera, renderer.domElement);
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 10, 5);
    scene.add(light);
    const ambient = new THREE.AmbientLight(0xffffff, 0.5);
    scene.add(ambient);

    roofRef.current = new THREE.Group();
    scene.add(roofRef.current);
    sceneRef.current = scene;

    const animate = function () {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
    };
    animate();

    return () => {
      renderer.dispose();
      container.innerHTML = '';
    };
  }, []);

  const handleAutoFill = () => {
    if (!sceneRef.current || !roofRef.current) return;
    const panelsPerRow = Math.floor(width / 1.134);
    const rows = Math.floor(length / 1.722);
    const count = panelsPerRow * rows;
    setNumPanels(count);
    const k = (count * 420) / 1000;
    setKwp(k.toFixed(2));
    // draw roof and panels
    const roof = roofRef.current;
    while (roof.children.length) roof.remove(roof.children[0]);
    const angle = (pitch * Math.PI) / 180;
    const roofGeom = new THREE.PlaneGeometry(width, length);
    const roofMat = new THREE.MeshBasicMaterial({ color: 0xcccccc, side: THREE.DoubleSide });
    const roofMesh = new THREE.Mesh(roofGeom, roofMat);
    roofMesh.rotation.x = -angle;
    roof.add(roofMesh);
    for (let i = 0; i < rows; i++) {
      for (let j = 0; j < panelsPerRow; j++) {
        const panelGeom = new THREE.PlaneGeometry(1.134, 1.722);
        const panelMat = new THREE.MeshBasicMaterial({ color: 0x008996, side: THREE.DoubleSide });
        const panel = new THREE.Mesh(panelGeom, panelMat);
        panel.rotation.x = -angle;
        panel.position.x = -width / 2 + 1.134 / 2 + j * 1.134;
        panel.position.y = 0.01;
        panel.position.z = -length / 2 + 1.722 / 2 + i * 1.722;
        roof.add(panel);
      }
    }

    fetch('/api/calc', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phase: '1F', numPanels: count })
    })
      .then(r => r.json())
      .then(data => setPackages(data.packages || []));
  };

  return (
    <div>
      <div id="controls">
        <label>Width (m): <input type="number" value={width} onChange={e => setWidth(parseFloat(e.target.value))} /></label>
        <label>Length (m): <input type="number" value={length} onChange={e => setLength(parseFloat(e.target.value))} /></label>
        <label>Pitch (°): <input type="number" value={pitch} onChange={e => setPitch(parseFloat(e.target.value))} /></label>
        <button onClick={handleAutoFill}>Auto Fill Panels</button>
      </div>
      <div id="scene-container"></div>
      <div id="summary" style={{ padding: '1rem' }}>
        <p>Panels: {numPanels}</p>
        <p>kWp: {kwp}</p>
        <div>
          {packages.map((p, i) => (
            <div key={i}>
              <strong>{p.phase} {p.kwp}kWp</strong> - {p.Cena}€ ({p.panels} panels)
            </div>
          ))}
        </div>
      </div>
      <LeadForm numPanels={numPanels} kwp={kwp} selected={packages[0]} />
    </div>
  );
}

function LeadForm({ numPanels, kwp, selected }) {
  const [name, setName] = React.useState('');
  const [email, setEmail] = React.useState('');
  const [phone, setPhone] = React.useState('');
  const handleSubmit = () => {
    fetch('/api/lead', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, phone, numPanels, kwp, package: selected })
    })
      .then(r => r.json())
      .then(() => alert('Sent!'));
  };
  return (
    <div style={{ padding: '1rem' }}>
      <h2>Prejmi ponudbo</h2>
      <input placeholder="Ime" value={name} onChange={e => setName(e.target.value)} />
      <input placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} />
      <input placeholder="Telefon" value={phone} onChange={e => setPhone(e.target.value)} />
      <button onClick={handleSubmit}>Pošlji</button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
